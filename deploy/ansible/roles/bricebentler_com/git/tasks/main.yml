---
- name: Include secrets for bricebentler.com app
  include_vars: secrets.yml

- name: Ensure the app root directory does not exist
  file:
    state: absent
    path: "{{ bricebentler_app_root }}"

- name: Clone the application via git
  git:
    repo: "{{ bricebentler_com_git_repo }}"
    dest: "{{ bricebentler_app_root }}"
    clone: yes
    update: yes
    version: "{{ bricebentler_com_git_tag }}"
    accept_hostkey: true
    key_file: "{{ rsa_keys_bitbucket_path }}"

- name: Copy the catalog config file
  template:
    src: '.env.j2'
    dest: "{{ bricebentler_app_root }}/etc/.env"
    mode: 0640
    owner: "{{ nginx_user_name }}"
    group: "{{ nginx_group_name }}"

- name: Install composer packages
  composer:
    command: install
    working_dir: "{{ bricebentler_app_root }}"
    no_dev: yes
    optimize_autoloader: yes
#  shell: "{{ composer_bin_path }} install --quiet --no-dev --optimize-autoloader"
#  args:
#    chdir: "{{ bricebentler_app_root }}"
