---
# Ansible doesn't have a nice way to list a single object on S3.
# So download to /dev/null. If successful, file already exists, so fail.
- name: Check if RPM already exists on S3
  aws_s3:
    bucket: "{{ rpm_s3_bucket }}"
    object: "{{ rpm_s3_dir_path }}/{{ rpm_file_name }}"
    dest: '/dev/null'
    mode: 'get'
  delegate_to: 127.0.0.1
  become: no
  register: create_rpm_s3_list_output
  ignore_errors: True

- name: Fail if RPM file name already exists on S3
  fail:
    msg: "Current build filename already exists on S3 at: s3://{{ rpm_s3_bucket }}{{ rpm_s3_dir_path }}/{{ rpm_file_name }}"
  when: "create_rpm_s3_list_output.failed == False"
